<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Qarz daftari</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f2f5f8;padding:15px}
h2{text-align:center}
button{padding:14px;margin:6px 0;width:100%;font-size:16px;border:none;border-radius:6px;color:#fff}
.green{background:#2e7d32}
.blue{background:#1565c0}
.orange{background:#ef6c00}
.gray{background:#607d8b}
input{padding:12px;width:100%;margin:6px 0;border-radius:6px;border:1px solid #ccc}
.card{background:#fff;padding:10px;border-radius:6px;margin:6px 0}
.hidden{display:none}
</style>
</head>
<body>

<h2 id="title">ğŸ“’ Qarz daftari</h2>

<div id="menu">
  <button class="green" onclick="openAdd()">â• Qarz qoâ€˜shish</button>
  <button class="blue" onclick="openSearch()">ğŸ” Qidirish</button>
  <button class="orange" onclick="exportCSV()">ğŸ“¤ Excel (CSV)</button>
</div>

<div id="addBox" class="hidden">
  <input id="date" type="date">
  <input id="name" placeholder="Ism familiya">
  <input id="phone" placeholder="Telefon raqam">
  <input id="total" type="number" placeholder="Qarz summasi">
  <input id="photo" placeholder="Rasm link (ixtiyoriy)">
  <button class="green" onclick="saveDebt()">ğŸ’¾ Saqlash</button>
  <button class="gray" onclick="back()">â¬… Orqaga</button>
</div>

<div id="searchBox" class="hidden">
  <input id="query" placeholder="Ism yoki telefon (2-3 belgi yetadi)">
  <button class="blue" onclick="search()">ğŸ” Qidirish</button>
  <div id="list"></div>
  <button class="gray" onclick="back()">â¬… Orqaga</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbx8XSb_JTNDZ7kq5yRIUTgdljyDV-TztkBqa4LG918whyAgW5QTPcRqmmQX6t2E2nhaUQ/exec";

date.valueAsDate = new Date();

function openAdd(){
  title.innerText="â• Qarz qoâ€˜shish";
  menu.classList.add("hidden");
  addBox.classList.remove("hidden");
}

function openSearch(){
  title.innerText="ğŸ” Qidirish";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
}

function back(){
  title.innerText="ğŸ“’ Qarz daftari";
  menu.classList.remove("hidden");
  addBox.classList.add("hidden");
  searchBox.classList.add("hidden");
}

function saveDebt(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      date: date.value,
      name: name.value,
      phone: phone.value,
      total: total.value,
      photo: photo.value
    })
  })
  .then(r=>r.text())
  .then(t=>{
    if(t!=="OK") throw t;
    alert("âœ… Saqlandi");
    back();
  })
  .catch(e=>alert("âŒ "+e));
}

function search(){
  fetch(API+"?q="+encodeURIComponent(query.value))
  .then(r=>r.json())
  .then(show);
}

function show(arr){
  list.innerHTML="";
  arr.forEach(x=>{
    list.innerHTML+=`
      <div class="card">
        ğŸ“… ${x.date}<br>
        ğŸ‘¤ ${x.name}<br>
        ğŸ“ ${x.phone}<br>
        ğŸ’° ${x.total}<br>
        ${x.photo ? `<a href="${x.photo}" target="_blank">ğŸ“· Rasm</a>`:""}
      </div>`;
  });
}

function exportCSV(){
  fetch(API)
  .then(r=>r.json())
  .then(data=>{
    let csv="Sana,Ism,Telefon,Qarz,Rasm\n";
    data.forEach(x=>{
      csv+=`${x.date},${x.name},${x.phone},${x.total},${x.photo}\n`;
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="qarzlar.csv";
    a.click();
  });
}
</script>

</body>
</html>
