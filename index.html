<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyd81D998Alfz0g9a3Umy61Ym59P8KePoZVgpAY8SpXqtJtZUR2mgSnjsdEfYa2Vj2PGw/exec";

/* ===== UI ===== */
function openAdd(){
  title.innerText = "â• Qarz qoâ€˜shish";
  menu.classList.add("hidden");
  addBox.classList.remove("hidden");
}

function openSearch(){
  title.innerText = "ğŸ” Qidirish";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
  results.innerHTML = "";
}

function goBack(){
  title.innerText = "ğŸ“’ Qarz daftari";
  menu.classList.remove("hidden");
  addBox.classList.add("hidden");
  searchBox.classList.add("hidden");
  results.innerHTML = "";
}

/* ===== ADD (Google Sheets ga yozadi) ===== */
function saveDebt(){
  if(!name.value || !phone.value || !total.value){
    alert("â— Majburiy maydonlar toâ€˜ldirilmagan");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      name: name.value.trim(),
      phone: phone.value.trim(),
      total: Number(total.value),
      date: new Date().toLocaleString()
    })
  })
  .then(r => r.text())
  .then(() => {
    alert("âœ… Qarz saqlandi");
    name.value = "";
    phone.value = "";
    total.value = "";
    goBack();
  })
  .catch(() => alert("âŒ Xatolik yuz berdi"));
}

/* ===== SEARCH (Ism yoki telefon) ===== */
function doSearch(){
  const q = query.value.trim();
  if(!q){
    alert("ğŸ” Qidirish uchun ism yoki telefon yozing");
    return;
  }

  results.innerHTML = "â³ Qidirilmoqda...";

  fetch(API_URL + "?action=search&q=" + encodeURIComponent(q))
    .then(r => r.json())
    .then(showResults)
    .catch(() => results.innerHTML = "âŒ Xatolik");
}

/* ===== LOAD ALL ===== */
function loadAll(){
  title.innerText = "ğŸ“‹ Barcha qarzlar";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
  results.innerHTML = "â³ Yuklanmoqda...";

  fetch(API_URL)
    .then(r => r.json())
    .then(showResults)
    .catch(() => results.innerHTML = "âŒ Xatolik");
}

/* ===== RENDER ===== */
function showResults(list){
  results.innerHTML = "";

  if(!list || list.length === 0){
    results.innerHTML = "âŒ Maâ€™lumot topilmadi";
    return;
  }

  list.forEach(d => {
    const remain = d.total - d.paid;
    const status = remain === 0 ? "ğŸŸ¢ Yopilgan" : "ğŸ”´ Ochiq";
    const cls = remain === 0 ? "green" : "";

    results.innerHTML += `
      <div class="card ${cls}">
        <b>${d.name}</b><br>
        ğŸ“ ${d.phone}<br>
        ğŸ’° Jami: ${d.total}<br>
        ğŸ’µ Toâ€˜langan: ${d.paid}<br>
        ğŸ“‰ Qolgan: ${remain}<br>
        ğŸ“Œ ${status}<br>
        ğŸ•’ ${d.date}
      </div>
    `;
  });
}
</script>
