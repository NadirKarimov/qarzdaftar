<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyd81D998Alfz0g9a3Umy61Ym59P8KePoZVgpAY8SpXqtJtZUR2mgSnjsdEfYa2Vj2PGw/exec";

/* ===== UI ===== */
function openAdd(){
  title.innerText="â• Qarz qoâ€˜shish";
  menu.classList.add("hidden");
  addBox.classList.remove("hidden");
}
function openSearch(){
  title.innerText="ğŸ” Qidirish";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
}
function goBack(){
  title.innerText="ğŸ“’ Qarz daftari";
  menu.classList.remove("hidden");
  addBox.classList.add("hidden");
  searchBox.classList.add("hidden");
  results.innerHTML="";
}

/* ===== ADD ===== */
function saveDebt(){
  if(!name.value || !phone.value || !total.value){
    alert("Majburiy maydonlar toâ€˜ldirilmagan");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      name: name.value,
      phone: phone.value,
      total: Number(total.value),
      date: new Date().toLocaleString()
    })
  })
  .then(r => r.text())
  .then(() => {
    alert("âœ… Qarz saqlandi");
    name.value = "";
    phone.value = "";
    total.value = "";
    goBack();
  })
  .catch(err => {
    alert("âŒ Xatolik: " + err);
  });
}

/* ===== SEARCH ===== */
function doSearch(){
  results.innerHTML = "â³ Qidirilmoqda...";

  fetch(API_URL + "?action=search&q=" + encodeURIComponent(query.value))
    .then(r => r.json())
    .then(data => {
      results.innerHTML = "";

      if(!data || data.length === 0){
        results.innerHTML = "âŒ Natija topilmadi";
        return;
      }

      data.forEach(d => {
        const remain = d.total - d.paid;
        const status = remain === 0 ? "ğŸŸ¢ Yopilgan" : "ğŸ”´ Ochiq";

        results.innerHTML += `
          <div class="card ${remain===0?'green':''}">
            <b>${d.name}</b><br>
            ğŸ“ ${d.phone}<br>
            ğŸ’° Jami: ${d.total}<br>
            ğŸ’µ Toâ€˜langan: ${d.paid}<br>
            ğŸ“‰ Qolgan: ${remain}<br>
            ğŸ“Œ ${status}<br>
            ğŸ•’ ${d.date}
          </div>
        `;
      });
    })
    .catch(err=>{
      results.innerHTML="âŒ Xatolik: "+err;
    });
}

/* ===== LOAD ALL ===== */
function loadAll(){
  title.innerText="ğŸ“‹ Barcha qarzlar";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
  results.innerHTML="â³ Yuklanmoqda...";

  fetch(API_URL)
    .then(r=>r.json())
    .then(showResults)
    .catch(e=>results.innerHTML="âŒ Xatolik");
}

/* ===== RENDER ===== */
function showResults(list){
  results.innerHTML="";
  list.forEach(d=>{
    const remain = d.total - d.paid;
    const cls = remain===0 ? "green" : "";
    results.innerHTML += `
      <div class="card ${cls}">
        <b>${d.name}</b><br>
        ğŸ“ ${d.phone}<br>
        ğŸ’° Jami: ${d.total}<br>
        ğŸ’µ Toâ€˜langan: ${d.paid}<br>
        ğŸ“‰ Qolgan: ${remain}
      </div>`;
  });
}
</script>
