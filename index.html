<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìí Qarz daftari</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f6f8; padding:15px; }
  h2 { text-align:center; margin:10px 0 15px; }
  button { width:100%; padding:12px; margin:6px 0; font-size:16px; border:none; border-radius:10px; cursor:pointer; }
  .add { background:#2ea043; color:#fff; }
  .search { background:#0969da; color:#fff; }
  .export { background:#f59e0b; color:#fff; }
  .back { background:#6c757d; color:#fff; }
  input { width:100%; padding:10px; margin:6px 0; border:1px solid #ccc; border-radius:10px; font-size:15px; }
  .hidden { display:none; }
  .card { border:1px solid #ddd; padding:10px; margin-top:10px; background:#fff; border-radius:12px; }
  .row { display:flex; gap:10px; }
  .row button { width:50%; }
  .small { font-size:13px; color:#666; }
  table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; border-radius:12px; overflow:hidden; }
  th, td { border-bottom:1px solid #eee; padding:10px; text-align:left; font-size:14px; }
  th { background:#f0f3f6; }
  a { word-break: break-all; }
  .error { color:#b00020; font-weight:bold; margin-top:8px; }
</style>
</head>

<body>
<h2 id="title">üìí Qarz daftari</h2>

<div id="menu">
  <button class="add" id="btnOpenAdd">‚ûï Qarz qo‚Äòshish</button>
  <button class="search" id="btnOpenSearch">üîç Qidirish</button>
  <button class="export" id="btnExport">üì§ Excel (CSV)</button>
</div>

<!-- ADD -->
<div id="addBox" class="hidden">
  <input id="inpDate" type="date" />
  <input id="inpName" placeholder="Ism familiya" />
  <input id="inpPhone" placeholder="Telefon raqam" inputmode="numeric" />
  <input id="inpTotal" type="number" placeholder="Qarz summasi (so‚Äòm)" />
  <div class="small">üì∑ Rasm ixtiyoriy (hozircha link sifatida saqlanadi). Keyin Drive upload qo‚Äòshamiz.</div>
  <input id="inpPhotoLink" placeholder="Rasm link (ixtiyoriy) - masalan: https://..." />

  <button class="add" id="btnSave">üíæ Saqlash</button>
  <button class="back" id="btnBack1">üîô Orqaga</button>
  <div id="addErr" class="error"></div>
</div>

<!-- SEARCH -->
<div id="searchBox" class="hidden">
  <input id="inpQuery" placeholder="Ism yoki telefon orqali qidirish" />
  <div class="row">
    <button class="search" id="btnDoSearch">üîé Qidirish</button>
    <button class="search" id="btnLoadAll">üìã Barchasini ko‚Äòrish</button>
  </div>

  <div id="results"></div>

  <button class="back" id="btnBack2">üîô Orqaga</button>
</div>

<script>
/** üî• BU YERGA SIZNING YANGI /exec LINKINGIZ QO‚ÄòYILADI */
const API_URL = "https://script.google.com/macros/s/AKfycbz2J2obW1LXS5yy_ARNrCCxacBRqfhmNFtCXFy3YDPwlhxvt6nMtG_fnhNmTUYz31-35Q/exec";

/* ===== ELEMENTS ===== */
const elTitle = document.getElementById("title");
const elMenu = document.getElementById("menu");

const elAddBox = document.getElementById("addBox");
const elSearchBox = document.getElementById("searchBox");

const inpDate = document.getElementById("inpDate");
const inpName = document.getElementById("inpName");
const inpPhone = document.getElementById("inpPhone");
const inpTotal = document.getElementById("inpTotal");
const inpPhotoLink = document.getElementById("inpPhotoLink");
const addErr = document.getElementById("addErr");

const inpQuery = document.getElementById("inpQuery");
const results = document.getElementById("results");

/* ===== HELPERS ===== */
function todayISO(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${m}-${day}`;
}
inpDate.value = todayISO();

function showMenu(){
  elTitle.innerText = "üìí Qarz daftari";
  elMenu.classList.remove("hidden");
  elAddBox.classList.add("hidden");
  elSearchBox.classList.add("hidden");
  results.innerHTML = "";
  addErr.textContent = "";
}
function openAdd(){
  elTitle.innerText = "‚ûï Qarz qo‚Äòshish";
  elMenu.classList.add("hidden");
  elAddBox.classList.remove("hidden");
  elSearchBox.classList.add("hidden");
  addErr.textContent = "";
}
function openSearch(){
  elTitle.innerText = "üîç Qidirish";
  elMenu.classList.add("hidden");
  elAddBox.classList.add("hidden");
  elSearchBox.classList.remove("hidden");
  results.innerHTML = "";
  // kirgan zahoti hammasini ko‚Äòrsatib turamiz
  loadAll();
}

/* ===== API CALLS ===== */
async function apiGet(action, q){
  const url = new URL(API_URL);
  if (action) url.searchParams.set("action", action);
  if (q !== undefined) url.searchParams.set("q", q);
  const r = await fetch(url.toString(), { method:"GET" });
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.json();
}
async function apiAdd(payload){
  const r = await fetch(API_URL, {
    method:"POST",
    body: JSON.stringify(payload) // headers qo‚Äòymaymiz (preflight bo‚Äòlmasin)
  });
  const t = await r.text();
  return t;
}

/* ===== RENDER TABLE ===== */
function renderTable(list){
  if(!list || list.length === 0){
    results.innerHTML = "<div class='error'>‚ùå Natija topilmadi</div>";
    return;
  }

  const rowsHtml = list.map(x => `
    <tr>
      <td>${escapeHtml(x.date || "")}</td>
      <td>${escapeHtml(x.name || "")}</td>
      <td>${escapeHtml(String(x.total ?? ""))}</td>
      <td>${escapeHtml(x.phone || "")}</td>
      <td>${x.photo ? `<a href="${escapeAttr(x.photo)}" target="_blank">link</a>` : ""}</td>
    </tr>
  `).join("");

  results.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Sana</th>
          <th>Ism familiya</th>
          <th>Jami qarz</th>
          <th>Telefon</th>
          <th>Rasm link</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  `;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function escapeAttr(s){ return escapeHtml(s); }

/* ===== ACTIONS ===== */
async function saveDebt(){
  addErr.textContent = "";
  const date = inpDate.value;
  const name = inpName.value.trim();
  const phone = inpPhone.value.trim();
  const total = inpTotal.value.trim();
  const photo = inpPhotoLink.value.trim();

  if(!date || !name || !phone || !total){
    addErr.textContent = "‚ùó Barcha majburiy maydonlarni to‚Äòldiring (Sana, Ism, Telefon, Summa).";
    return;
  }

  try{
    const res = await apiAdd({
      action:"add",
      date,
      name,
      phone,
      total:Number(total),
      photo
    });

    if(res.trim() === "ok"){
      alert("‚úÖ Muvaffaqiyatli saqlandi");
      // clear
      inpName.value = "";
      inpPhone.value = "";
      inpTotal.value = "";
      inpPhotoLink.value = "";
      inpDate.value = todayISO();
      showMenu();
    } else if(res.trim() === "missing_fields"){
      addErr.textContent = "‚ùå Server: majburiy maydon yetishmayapti (Apps Script).";
    } else {
      addErr.textContent = "‚ùå Server javobi: " + res;
    }
  } catch(e){
    addErr.textContent = "‚ùå Failed to fetch. Deploy/Permission/URL tekshiring. ("+ e +")";
  }
}

async function loadAll(){
  results.innerHTML = "‚è≥ Yuklanmoqda...";
  try{
    const data = await apiGet("all");
    renderTable(data);
  } catch(e){
    results.innerHTML = "<div class='error'>‚ùå Barchasini ko‚Äòrsatishda xatolik: "+ e +"</div>";
  }
}

async function doSearch(){
  const q = inpQuery.value.trim();
  if(!q){
    // bo‚Äòsh bo‚Äòlsa hammasini ko‚Äòrsatamiz
    loadAll();
    return;
  }
  results.innerHTML = "‚è≥ Qidirilmoqda...";
  try{
    const data = await apiGet("search", q);
    renderTable(data);
  } catch(e){
    results.innerHTML = "<div class='error'>‚ùå Qidirishda xatolik: "+ e +"</div>";
  }
}

async function exportCSV(){
  try{
    const data = await apiGet("all");
    let csv = "Sana,Ism familiya,Jami qarz,Telefon,Rasm link\n";
    data.forEach(x=>{
      const line = [
        (x.date||""),
        (x.name||""),
        (x.total??""),
        (x.phone||""),
        (x.photo||"")
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
      csv += line + "\n";
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "qarzlar.csv";
    a.click();
  } catch(e){
    alert("‚ùå CSV export xato: " + e);
  }
}

/* ===== EVENTS ===== */
document.getElementById("btnOpenAdd").addEventListener("click", openAdd);
document.getElementById("btnOpenSearch").addEventListener("click", openSearch);
document.getElementById("btnExport").addEventListener("click", exportCSV);

document.getElementById("btnBack1").addEventListener("click", showMenu);
document.getElementById("btnBack2").addEventListener("click", showMenu);

document.getElementById("btnSave").addEventListener("click", saveDebt);
document.getElementById("btnDoSearch").addEventListener("click", doSearch);
document.getElementById("btnLoadAll").addEventListener("click", loadAll);
</script>

</body>
</html>

