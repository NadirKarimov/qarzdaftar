<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<title>ğŸ“’ Qarz daftari</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial; background:#f4f6f8; padding:15px; }
  h2 { text-align:center; }
  button { width:100%; padding:12px; margin:6px 0; font-size:16px; }
  .add { background:#2ea043; color:white; border:none; }
  .search { background:#0969da; color:white; border:none; }
  .export { background:#f59e0b; color:white; border:none; }
  .back { background:#6c757d; color:white; border:none; }
  input { width:100%; padding:10px; margin:5px 0; box-sizing:border-box; }
  .hidden { display:none; }
  .card { border:1px solid #ccc; padding:10px; margin-top:10px; background:#fff; border-radius:8px; }
  table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
  th { background:#eef2f7; text-align:left; }
  .muted { color:#6b7280; font-size:13px; }
</style>
</head>
<body>

<h2 id="title">ğŸ“’ Qarz daftari</h2>

<div id="menu">
  <button class="add" onclick="openAdd()">â• Qarz qoâ€˜shish</button>
  <button class="search" onclick="openSearch()">ğŸ” Qidirish</button>
  <button class="export" onclick="exportCSV()">ğŸ“¤ CSV (Excel)</button>
</div>

<!-- ADD -->
<div id="addBox" class="hidden">
  <input id="inpName" placeholder="Ism familiya" />
  <input id="inpPhone" placeholder="Telefon raqam" />
  <input id="inpTotal" type="number" placeholder="Qarz summasi (soâ€˜m)" />
  <div class="muted">ğŸ“· Rasm: kamera yoki galereya</div>
  <input id="inpPhoto" type="file" accept="image/*" capture="environment" />
  <button class="add" onclick="saveDebt()">ğŸ’¾ Saqlash</button>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<!-- SEARCH -->
<div id="searchBox" class="hidden">
  <input id="inpQuery" placeholder="Ism yoki telefon boâ€˜yicha qidirish..." oninput="doSearch()" />
  <div id="results"></div>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyd81D998Alfz0g9a3Umy61Ym59P8KePoZVgpAY8SpXqtJtZUR2mgSnjsdEfYa2Vj2PGw/exec";

const elTitle   = document.getElementById("title");
const elMenu    = document.getElementById("menu");
const elAddBox  = document.getElementById("addBox");
const elSearch  = document.getElementById("searchBox");
const elResults = document.getElementById("results");

const elName  = document.getElementById("inpName");
const elPhone = document.getElementById("inpPhone");
const elTotal = document.getElementById("inpTotal");
const elPhoto = document.getElementById("inpPhoto");
const elQuery = document.getElementById("inpQuery");

let CACHE = []; // yuklangan ro'yxat

function openAdd(){
  elTitle.innerText = "â• Qarz qoâ€˜shish";
  elMenu.classList.add("hidden");
  elAddBox.classList.remove("hidden");
}

function openSearch(){
  elTitle.innerText = "ğŸ” Qidirish";
  elMenu.classList.add("hidden");
  elSearch.classList.remove("hidden");
  loadAll(); // kirganda hammasini ko'rsatadi
}

function goBack(){
  elTitle.innerText="ğŸ“’ Qarz daftari";
  elMenu.classList.remove("hidden");
  elAddBox.classList.add("hidden");
  elSearch.classList.add("hidden");
  elResults.innerHTML="";
  elQuery.value = "";
}

function saveDebt(){
  const name  = (elName.value || "").trim();
  const phone = (elPhone.value || "").trim();
  const total = (elTotal.value || "").trim();

  if(!name || !phone || !total){
    alert("Majburiy maydonlar toâ€˜ldirilmagan (Ism, Telefon, Qarz summasi)!");
    return;
  }

  const file = elPhoto.files && elPhoto.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => sendDebt(reader.result);
    reader.readAsDataURL(file);
  } else {
    sendDebt(""); // rasm ixtiyoriy
  }
}

function sendDebt(photoData){
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "add",
      name: (elName.value || "").trim(),
      phone: (elPhone.value || "").trim(),
      total: Number(elTotal.value),
      paid: 0,
      photo: photoData,
      date: new Date().toLocaleString()
    })
  })
  .then(async (r) => {
    const t = await r.text();
    if(!r.ok) throw new Error(t || ("HTTP " + r.status));
    return t;
  })
  .then(() => {
    alert("âœ… Muvaffaqiyatli saqlandi");
    elName.value = "";
    elPhone.value = "";
    elTotal.value = "";
    elPhoto.value = "";
    goBack();
  })
  .catch(err => {
    alert("âŒ Saqlashda xatolik: " + err.message);
  });
}

function loadAll(){
  elResults.innerHTML = "â³ Yuklanmoqda...";
  fetch(API_URL)
    .then(async (r) => {
      const text = await r.text();
      // JSON bo'lmasa ham ko'rib xato chiqaramiz:
      try { return JSON.parse(text); }
      catch { throw new Error("Server JSON qaytarmadi. Javob: " + text.slice(0,200)); }
    })
    .then(data => {
      CACHE = Array.isArray(data) ? data : [];
      renderTable(CACHE);
    })
    .catch(err => {
      elResults.innerHTML = "âŒ Yuklash xatosi: " + err.message;
    });
}

function doSearch(){
  const q = (elQuery.value || "").toLowerCase().trim();
  const filtered = CACHE.filter(d =>
    String(d.name || "").toLowerCase().includes(q) ||
    String(d.phone || "").includes(q)
  );
  renderTable(filtered);
}

function renderTable(list){
  if(!list || list.length === 0){
    elResults.innerHTML = "<div class='card'>âŒ Hech narsa topilmadi</div>";
    return;
  }

  // Siz soâ€˜ragan ustunlar:
  // Sana | Ism familiya | Qarz | Nomer | Yuklangan rasm link
  let html = `
    <table>
      <thead>
        <tr>
          <th>Sana</th>
          <th>Ism familiya</th>
          <th>Qarz</th>
          <th>Nomer</th>
          <th>Rasm</th>
        </tr>
      </thead>
      <tbody>
  `;

  list.forEach(d => {
    const date  = d.date || "";
    const name  = d.name || "";
    const phone = d.phone || "";
    const total = (d.total ?? "");
    const photo = d.photo || "";

    const photoCell = photo
      ? `<a href="${photo}" target="_blank">ğŸ“· Link</a>`
      : `<span class="muted">yoâ€˜q</span>`;

    html += `
      <tr>
        <td>${escapeHtml(date)}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(String(total))}</td>
        <td>${escapeHtml(phone)}</td>
        <td>${photoCell}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  elResults.innerHTML = html;
}

function exportCSV(){
  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      let csv="Sana,Ism,Telefon,Qarz,Rasm\n";
      data.forEach(d=>{
        csv += `"${(d.date||"").replaceAll('"','""')}","${(d.name||"").replaceAll('"','""')}","${(d.phone||"").replaceAll('"','""')}",${(d.total||0)},"${(d.photo||"").replaceAll('"','""')}"\n`;
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="qarzlar.csv";
      a.click();
    })
    .catch(()=>alert("âŒ CSV export xato"));
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>

</body>
</html>
