<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“’ Qarz daftari</title>

<style>
  body { font-family: Arial; background:#f4f6f8; padding:15px; }
  h2 { text-align:center; margin:10px 0 14px; }
  button { width:100%; padding:12px; margin:6px 0; font-size:16px; border-radius:10px; }
  .add { background:#2ea043; color:white; border:none; }
  .search { background:#0969da; color:white; border:none; }
  .back { background:#6c757d; color:white; border:none; }
  .export { background:#f59e0b; color:white; border:none; }
  input { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:1px solid #cfd6dd; }
  .hidden { display:none; }
  .card { border:1px solid #d0d7de; padding:12px; margin-top:10px; background:#fff; border-radius:12px; }
  .row { display:flex; gap:10px; }
  .row > div { flex:1; }
  .hint { font-size:12px; color:#57606a; margin-top:4px; }
  .error { color:#b42318; font-weight:700; }
</style>
</head>

<body>
<h2 id="title">ğŸ“’ Qarz daftari</h2>

<div id="menu">
  <button class="add" onclick="openAdd()">â• Qarz qoâ€˜shish</button>
  <button class="search" onclick="openSearch()">ğŸ” Qidirish</button>
  <button class="export" onclick="exportCSV()">ğŸ“¤ Excel (CSV)</button>
</div>

<!-- ADD -->
<div id="addBox" class="hidden">
  <input id="debtDate" type="date" />

  <input id="fullName" placeholder="Ism familiya" />
  <input id="phoneNumber" placeholder="Telefon raqam" inputmode="tel" />
  <input id="totalAmount" type="number" placeholder="Jami qarz (soâ€˜m)" inputmode="numeric" />

  <div class="hint">ğŸ“· Rasm ixtiyoriy. (Galereyadan tanlasa ham boâ€˜ladi)</div>
  <input id="photoFile" type="file" accept="image/*" />

  <button class="add" onclick="saveDebt()">ğŸ’¾ Saqlash</button>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<!-- SEARCH -->
<div id="searchBox" class="hidden">
  <input id="query" placeholder="Ism yoki telefon orqali qidirish" />
  <div class="row">
    <div><button class="search" onclick="doSearch()">ğŸ” Qidirish</button></div>
    <div><button class="search" onclick="loadAll()">ğŸ“‹ Barchasini koâ€˜rish</button></div>
  </div>
  <div id="results"></div>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<script>
/* âœ… Yangi Apps Script Web App link */
const API_URL = "https://script.google.com/macros/s/AKfycbzCzvclQVGECPNa5i4HvkNWqcX1XfOUZyjgOIrIbVNXrjOvtbA9Heah0GkSBpODSryfHw/exec";

/* elementlar (window.name bilan toâ€˜qnashmasin!) */
const elTitle = document.getElementById("title");
const elMenu = document.getElementById("menu");
const elAddBox = document.getElementById("addBox");
const elSearchBox = document.getElementById("searchBox");
const elResults = document.getElementById("results");

const elDate = document.getElementById("debtDate");
const elFullName = document.getElementById("fullName");
const elPhone = document.getElementById("phoneNumber");
const elTotal = document.getElementById("totalAmount");
const elPhoto = document.getElementById("photoFile");
const elQuery = document.getElementById("query");

/* Sana default: bugun */
elDate.value = new Date().toISOString().split("T")[0];

/* UI */
function openAdd(){
  elTitle.innerText = "â• Qarz qoâ€˜shish";
  elMenu.classList.add("hidden");
  elAddBox.classList.remove("hidden");
}
function openSearch(){
  elTitle.innerText = "ğŸ” Qidirish";
  elMenu.classList.add("hidden");
  elSearchBox.classList.remove("hidden");
  // Qidirishga kirgan zahoti hammasini koâ€˜rsatib yuboramiz:
  loadAll();
}
function goBack(){
  elTitle.innerText="ğŸ“’ Qarz daftari";
  elMenu.classList.remove("hidden");
  elAddBox.classList.add("hidden");
  elSearchBox.classList.add("hidden");
  elResults.innerHTML="";
}

/* ADD */
async function saveDebt(){
  const date = (elDate.value || "").trim();
  const name = (elFullName.value || "").trim();
  const phone = (elPhone.value || "").trim();
  const total = (elTotal.value || "").trim();

  if(!date || !name || !phone || !total){
    alert("â— Barcha majburiy maydonlarni toâ€˜ldiring");
    return;
  }

  const fd = new FormData();
  fd.append("action", "add");
  fd.append("date", date);
  fd.append("name", name);
  fd.append("phone", phone);
  fd.append("total", total);

  if (elPhoto.files && elPhoto.files[0]) {
    fd.append("photo", elPhoto.files[0]);
  }

  try{
    // Apps Script ba'zan redirect qiladi, shuning uchun follow
    const res = await fetch(API_URL, { method:"POST", body: fd, redirect:"follow" });
    const txt = await res.text();

    // Agar server xato qaytarsa koâ€˜rsatib beramiz:
    if(!res.ok){
      alert("âŒ Server xatosi: " + res.status + "\n" + txt);
      return;
    }

    alert("âœ… Muvaffaqiyatli saqlandi");

    // tozalash
    elFullName.value = "";
    elPhone.value = "";
    elTotal.value = "";
    elPhoto.value = "";
    elDate.value = new Date().toISOString().split("T")[0];

    // qidirishga qaytib, roâ€˜yxatni koâ€˜rsatamiz
    openSearch();
  }catch(e){
    alert("âŒ Failed to fetch (Deploy/Permission/CORS boâ€˜lishi mumkin)\n\n" + e);
  }
}

/* SEARCH */
async function doSearch(){
  const q = (elQuery.value || "").trim();
  elResults.innerHTML = "â³ Yuklanmoqda...";

  try{
    const res = await fetch(API_URL + "?action=search&q=" + encodeURIComponent(q));
    const data = await res.json();
    showResults(data);
  }catch(e){
    elResults.innerHTML = `<div class="error">âŒ Xatolik: ${e}</div>`;
  }
}

/* LOAD ALL */
async function loadAll(){
  elResults.innerHTML = "â³ Yuklanmoqda...";

  try{
    // koâ€˜p Apps Scriptlarda "hammasi" â€” shunchaki /exec ni ochish
    const res = await fetch(API_URL);
    const data = await res.json();
    showResults(data);
  }catch(e){
    elResults.innerHTML = `<div class="error">âŒ Barchasini koâ€˜rsatishda xatolik: ${e}</div>`;
  }
}

/* RENDER: Sana | Ism | Jami | Telefon | Rasm link */
function showResults(list){
  elResults.innerHTML = "";

  if(!list || !Array.isArray(list) || list.length === 0){
    elResults.innerHTML = "âŒ Maâ€™lumot topilmadi";
    return;
  }

  list.forEach(d=>{
    const date = d.date ?? "";
    const name = d.name ?? "";
    const phone = d.phone ?? "";
    const total = d.total ?? "";
    const photo = d.photo ?? "";

    elResults.innerHTML += `
      <div class="card">
        ğŸ—“ <b>Sana:</b> ${escapeHtml(date)}<br>
        ğŸ‘¤ <b>Ism:</b> ${escapeHtml(name)}<br>
        ğŸ’° <b>Jami qarz:</b> ${escapeHtml(String(total))}<br>
        ğŸ“ <b>Tel:</b> ${escapeHtml(phone)}<br>
        ğŸ–¼ <b>Rasm:</b> ${photo ? `<a href="${photo}" target="_blank">Link</a>` : "â€”"}
      </div>
    `;
  });
}

/* CSV */
async function exportCSV(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();

    let csv = "Sana,Ism,Telefon,Jami,Rasm\n";
    data.forEach(d=>{
      csv += `${csvSafe(d.date)},${csvSafe(d.name)},${csvSafe(d.phone)},${csvSafe(d.total)},${csvSafe(d.photo)}\n`;
    });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8"}));
    a.download = "qarzlar.csv";
    a.click();
  }catch(e){
    alert("âŒ CSV export xato: " + e);
  }
}

/* helpers */
function csvSafe(v){
  v = (v ?? "").toString().replaceAll('"','""');
  return `"${v}"`;
}
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
