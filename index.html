<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>ğŸ“’ Qarz daftari</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
h2 { text-align:center; }
button { width:100%; padding:12px; margin:6px 0; font-size:16px; }
.add { background:#2ea043; color:white; border:none; }
.search { background:#0969da; color:white; border:none; }
.back { background:#6c757d; color:white; border:none; }
.export { background:#f59e0b; color:white; border:none; }
input { width:100%; padding:10px; margin:5px 0; }
.hidden { display:none; }
.card { border:1px solid #ccc; padding:10px; margin-top:10px; background:#fff; }
.green { background:#d4edda; }
</style>
</head>

<body>

<h2 id="title">ğŸ“’ Qarz daftari</h2>

<div id="menu">
  <button class="add" onclick="openAdd()">â• Qarz qoâ€˜shish</button>
  <button class="search" onclick="openSearch()">ğŸ” Qidirish</button>
  <button class="export" onclick="exportCSV()">ğŸ“¤ Excel (CSV)</button>
</div>

<!-- ADD -->
<div id="addBox" class="hidden">
  <input id="name" placeholder="Ism familiya" required>
  <input id="phone" placeholder="Telefon raqam" required>
  <input id="total" type="number" placeholder="Qarz summasi (soâ€˜m)" required>
  <input id="photo" type="file" accept="image/*">
  <button class="add" onclick="saveDebt()">ğŸ’¾ Saqlash</button>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<!-- SEARCH -->
<div id="searchBox" class="hidden">
  <input id="query" placeholder="Ism yoki telefon orqali qidirish">
  <button class="search" onclick="doSearch()">ğŸ” Qidirish</button>
  <button class="search" onclick="loadAll()">ğŸ“‹ Barchasini koâ€˜rish</button>
  <div id="results"></div>
  <button class="back" onclick="goBack()">ğŸ”™ Orqaga</button>
</div>

<script>
/* ==============================
   ğŸ”— GOOGLE APPS SCRIPT API
   ============================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzCzvclQVGECPNa5i4HvkNWqcX1XfOUZyjgOIrIbVNXrjOvtbA9Heah0GkSBpODSryfHw/exec";

/* ===== UI ===== */
function openAdd(){
  title.innerText="â• Qarz qoâ€˜shish";
  menu.classList.add("hidden");
  addBox.classList.remove("hidden");
}
function openSearch(){
  title.innerText="ğŸ” Qidirish";
  menu.classList.add("hidden");
  searchBox.classList.remove("hidden");
}
function goBack(){
  title.innerText="ğŸ“’ Qarz daftari";
  menu.classList.remove("hidden");
  addBox.classList.add("hidden");
  searchBox.classList.add("hidden");
  results.innerHTML="";
}

/* ===== ADD ===== */
function saveDebt(){
  if(!name.value || !phone.value || !total.value){
    alert("â— Majburiy maydonlar toâ€˜ldirilmagan");
    return;
  }

  const formData = new FormData();
  formData.append("action", "add");
  formData.append("name", name.value);
  formData.append("phone", phone.value);
  formData.append("total", total.value);
  formData.append("date", new Date().toLocaleString());

  if(photo.files[0]){
    formData.append("photo", photo.files[0]);
  }

  fetch(API_URL, {
    method: "POST",
    body: formData
  })
  .then(r => r.text())
  .then(res => {
    alert("âœ… Muvaffaqiyatli saqlandi");
    name.value="";
    phone.value="";
    total.value="";
    photo.value="";
    goBack();
  })
  .catch(err => alert("âŒ Xatolik: " + err));
}

/* ===== SEARCH ===== */
function doSearch(){
  const q = query.value.trim();
  results.innerHTML = "â³ Yuklanmoqda...";

  fetch(API_URL + "?action=search&q=" + encodeURIComponent(q))
    .then(r => r.json())
    .then(showResults)
    .catch(()=>results.innerHTML="âŒ Xatolik");
}

/* ===== LOAD ALL ===== */
function loadAll(){
  results.innerHTML = "â³ Yuklanmoqda...";
  fetch(API_URL + "?action=all")
    .then(r => r.json())
    .then(showResults)
    .catch(()=>results.innerHTML="âŒ Xatolik");
}

/* ===== RENDER ===== */
function showResults(list){
  results.innerHTML="";
  if(!list || list.length===0){
    results.innerHTML="âŒ Maâ€™lumot topilmadi";
    return;
  }

  list.forEach(d=>{
    const remain = d.total - d.paid;
    const cls = remain===0 ? "green" : "";
    results.innerHTML += `
      <div class="card ${cls}">
        ğŸ•’ ${d.date}<br>
        <b>${d.name}</b><br>
        ğŸ“ ${d.phone}<br>
        ğŸ’° Qarz: ${d.total}<br>
        ğŸ’µ Toâ€˜langan: ${d.paid}<br>
        ğŸ“‰ Qolgan: ${remain}<br>
        ${d.photo ? `ğŸ–¼ <a href="${d.photo}" target="_blank">Rasm</a>` : ""}
      </div>`;
  });
}

/* ===== CSV ===== */
function exportCSV(){
  fetch(API_URL+"?action=all")
    .then(r=>r.json())
    .then(data=>{
      let csv="Sana,Ism,Telefon,Qarz,To'langan,Rasm\n";
      data.forEach(d=>{
        csv+=`${d.date},${d.name},${d.phone},${d.total},${d.paid},${d.photo||""}\n`;
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="qarzlar.csv";
      a.click();
    });
}
</script>

</body>
</html>
