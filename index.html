<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Qarz Daftari</title>
<style>
body{font-family:Arial;background:#f5f7fa;padding:15px}
button{padding:12px;margin:6px;border:none;border-radius:6px;font-size:16px}
.green{background:#2e7d32;color:#fff}
.blue{background:#1565c0;color:#fff}
.orange{background:#ef6c00;color:#fff}
.gray{background:#555;color:#fff}
.card{background:#fff;padding:10px;margin:8px;border-radius:6px}
input{width:100%;padding:10px;margin:6px}
.hidden{display:none}
</style>
</head>

<body>

<h2>ğŸ“’ Qarz daftari</h2>

<div id="menu">
  <button class="green" onclick="openAdd()">â• Qarz qoâ€˜shish</button>
  <button class="blue" onclick="openSearch()">ğŸ” Qidirish</button>
  <button class="orange" onclick="exportCSV()">ğŸ“¤ Excel (CSV)</button>
</div>

<div id="add" class="hidden">
  <input type="date" id="sana">
  <input placeholder="Ism" id="ism">
  <input placeholder="Telefon" id="tel">
  <input placeholder="Summa" id="summa" type="number">
  <input type="file" id="img" accept="image/*" capture="environment">
  <button class="green" onclick="save()">ğŸ’¾ Saqlash</button>
  <button class="gray" onclick="back()">â¬…ï¸ Orqaga</button>
</div>

<div id="search" class="hidden">
  <input placeholder="Ism yoki telefon" id="q" oninput="search()">
  <div id="list"></div>
  <button class="gray" onclick="back()">â¬…ï¸ Orqaga</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyo7RHFyMOPFJ-gZvfx7XSQXnZSpDRg_3rWz8GB7EPKY7IJO-5DQszWkuu9N4L9kuBHzw/exec";

function openAdd(){menu.hidden=true;add.hidden=false}
function openSearch(){menu.hidden=true;search.hidden=false;search()}
function back(){menu.hidden=false;add.hidden=true;search.hidden=true}

async function save(){
  const f = img.files[0];
  let image = "";
  if (f) {
    const r = new FileReader();
    r.onload = async () => {
      image = r.result;
      send(image);
    };
    r.readAsDataURL(f);
  } else send("");
}

function send(image){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      sana:sana.value,
      ism:ism.value,
      tel:tel.value,
      summa:summa.value,
      image:image
    })
  }).then(r=>r.json()).then(r=>{
    alert("âœ… Saqlandi");
    back();
  }).catch(e=>alert("âŒ Xato"));
}

function search(){
  fetch(API_URL+"?q="+q.value)
    .then(r=>r.json())
    .then(d=>{
      list.innerHTML="";
      d.forEach(x=>{
        list.innerHTML+=`
          <div class="card">
            <b>${x.ism}</b><br>
            ğŸ“ ${x.tel}<br>
            ğŸ’° ${x.summa}<br>
            ğŸ“… ${x.sana}<br>
            ${x.rasm?`<a href="${x.rasm}" target="_blank">ğŸ“· Rasm</a>`:""}
          </div>`;
      });
    });
}

function exportCSV(){
  fetch(API_URL)
    .then(r=>r.json())
    .then(d=>{
      let csv="Sana,Ism,Telefon,Summa,Rasm\n";
      d.forEach(x=>{
        csv+=`${x.sana},${x.ism},${x.tel},${x.summa},${x.rasm}\n`;
      });
      const a=document.createElement("a");
      a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
      a.download="qarzlar.csv";
      a.click();
    });
}
</script>
</body>
</html>
